[ src ]

url = https://www.kernel.org/pub/linux/kernel/v5.x/linux-<ver>.tar.xz
src_type = tar
src_dirname = <prog>-<ver>



[ vars ]



[ std ]

env =
prepare = tar --no-same-owner -xf <src_path> -C <tmp_dir>
configure = /home/xx/kernel/make-config .

# build for every config generated by make-config script in 'configure' step
build = for cfg in build/config-*-*; do
		machine=$(printf ${cfg} | cut -d'-' -f2) &&
		echo "* building for ${machine}..." &&
		cp ${cfg} .config &&
		make &&
		cp -av arch/x86/boot/bzImage build/vmlinuz-${machine} &&
		cp -av System.map build/System.map-${machine};
	done

# sources and objects are saved as an 'source' pkgset
pkg_create = mkdir <pkg_dir>/boot/ &&
	mv -v build/vmlinuz-generic build/vmlinuz &&
	mv -v build/System.map-generic build/System.map &&
	mv -v build/config-generic-<ver> build/config &&
	cp -av build/* <pkg_dir>/boot/ &&

	echo "* saving source in a separate pkgset" &&
	make mrproper &&
	rm -rf build/{vmlinuz,System.map}*
		arch/{mips,m68k,sparc,sh,s390,ia64,parisc}
		arch/{alpha,xtensa,um,arc,nds32,csky,microblaze,openrisc}
		arch/{hexagon,nios2,h8300}
		scripts/dtc/include-prefixes/{mips,nios2,sh,xtensa}
		scripts/dtc/include-prefixes/{arc,h8300,microblaze,openrisc}
		tools/testing
		&&
	mkdir -p <prog_dir>/pkg/source-<ver>-<pkg_rel>/usr/src/linux
		<prog_dir>/log/source-<ver>-<pkg_rel> &&
	cp -a . <prog_dir>/pkg/source-<ver>-<pkg_rel>/usr/src/linux/ &&
	find . -type f -print0 | xargs -0 sha256sum | sed 's|  |\t/|g' >
		<prog_dir>/log/source-<ver>-<pkg_rel>/sha256.log



[ perf ]

env =
prepare = tar --no-same-owner -xf <src_path> -C <tmp_dir>
configure =
build = cd tools/perf && make
pkg_create = cd tools/perf && make DESTDIR=<pkg_dir>/usr/ install &&
	mv -v <pkg_dir>/usr/lib64/* <pkg_dir>/usr/lib/ &&
	rmdir -v <pkg_dir>/usr/lib64 &&
	rm -r <pkg_dir>/usr/libexec/perf-core/tests



[ headers ]

env =
prepare = tar --no-same-owner -xf <src_path> -C <tmp_dir>
configure =
build = make mrproper &&
	make headers &&
	find usr/include -name '.*' -delete &&
	rm usr/include/Makefile

pkg_create = mkdir <pkg_dir>/usr && cp -a usr/include/ <pkg_dir>/usr/



[ headersstatic ]

env =
prepare = tar --no-same-owner -xf <src_path> -C <tmp_dir>
configure =
build = make mrproper &&
	make headers &&
	find usr/include -name '.*' -delete &&
	rm usr/include/Makefile

pkg_create = cp -a usr/include/ <pkg_dir>/



[ bootstrap_headers_cross ]

env =
prepare = tar --no-same-owner -xf <src_path> -C <tmp_dir>
configure =
build = make mrproper &&
	make headers &&
	find usr/include -name '.*' -delete &&
	rm usr/include/Makefile

pkg_create = mkdir <pkg_dir>/usr && cp -a usr/include/ <pkg_dir>/usr/



# this pkgset is created during 'std' build
[ source ]

env =
prepare =
configure =
build =
pkg_create = echo

